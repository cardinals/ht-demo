!function(K,U,N){"use strict";var Z="ht",F=K[Z],i=F.Default,$=i.def,Q=i.getInternal();F.HistoryManager=function(A){this._histories=[],this.setDataModel(A)},$(F.HistoryManager,U,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var B=this;B._betweenTransaction++,1===B._betweenTransaction&&(B._transactionHistories={})}},endTransaction:function(){if(0!==this._betweenTransaction){var g=this,X=g._histories;if(g._betweenTransaction>0&&g._betweenTransaction--,0===g._betweenTransaction){if(g._transactionHistories){var t=[];for(var Z in g._transactionHistories)t.push(g._transactionHistories[Z]);t.length&&(X=X.slice(0,g._historyIndex+1),X.push(t),X.length>g._maxHistoryCount&&(X=X.slice(X.length-g._maxHistoryCount)),g.setHistories(X),g.setHistoryIndex(X.length-1,!0))}delete g._transactionHistories}}},setDataModel:function(k){var R=this,A=R._dataModel;A!==k&&(A&&(delete A._historyManager,A.ump(R.handleDataModelPropertyChange,R),A.umm(R.$5p,R),A.umd(R.$6p,R),A.removeHierarchyChangeListener(R.handleHierarchyChange,R),A.removeIndexChangeListener(R.handleIndexChange,R)),R._dataModel=k,k&&(k._historyManager=R,k.mp(R.handleDataModelPropertyChange,R),k.mm(R.$5p,R),k.md(R.$6p,R),k.addHierarchyChangeListener(R.handleHierarchyChange,R),k.addIndexChangeListener(R.handleIndexChange,R)),R.fp("dataModel",A,k),R.clear())},setHistoryIndex:function($,T){var j=this,_=j._historyIndex,w=j._histories.length;if(-1>$?$=-1:$>=w&&($=w-1),_!==$){if(!T){var R=$-_;R>0?j.$2p(R):0>R&&j.$1p(-R)}j._historyIndex=$,j.fp("historyIndex",_,$),j.dataModel&&j.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(k){var U=this,x=U._histories,m=U._maxHistoryCount;(!k||0>=k)&&(k=10),m!==k&&(U._maxHistoryCount=k,U.fp("maxHistoryCount",m,k),x.length>k&&U.clear())},cloneValue:function(B){return F.Default.clone(B)},isPropertyUndoable:function(s){return s&&!this.ignoredPropertyMap[s]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(o){return o&&!this.ignoreDataModelPropertyMap[o]},$5p:function(n){this.handleChange(n,n.kind)},$6p:function(U){this.handleChange(U,"property")},handleHierarchyChange:function(w){this.handleChange(w,"hierarchy")},handleIndexChange:function(w){this.handleChange(w,"index")},handleDataModelPropertyChange:function(Z){this.handleChange(Z,"dataModelProperty")},toChildrenInfo:function(p){var X={};return X.data=p,X.children=[],p.eachChild(function(N){X.children.push(this.toChildrenInfo(N))},this),X},restoreChildren:function(L){var C=L.data;L.children.forEach(function(m){var F=m.data;F.getParent()!==C&&C.addChild(F),this._dataModel.contains(F)||this._dataModel.add(F),this.restoreChildren(m)},this)},handleChange:function(a,r){var Y=this;if(!(Y._disabled||Y._isUndoRedoing||i.loadingRefGraph)){var u,s=(Y._histories,a.data),k=a.property;if(!s||!(s._refGraph||s instanceof F.RefGraph)){if("property"===r)Y.isPropertyUndoable(k,s)&&(u={kind:r,data:s,property:k,oldValue:Y.cloneValue(a.oldValue,s,k),newValue:Y.cloneValue(a.newValue,s,k),event:a});else if("hierarchy"===r||"index"===r&&Y.isIndexUndoable(a))u={kind:r,data:s,oldIndex:a.oldIndex,newIndex:a.newIndex,event:a};else if("clear"===r)u={kind:r,json:a.json,event:a};else if("add"===r){if(u={kind:r,data:s,event:a,childrenInfo:this.toChildrenInfo(s),parent:s.getParent()},u.parent){var P=Y._dataModel.getSiblings(s);u.siblingsIndex=P.indexOf(s)}s instanceof F.Node&&(u.host=s.getHost(),u.attaches=s.getAttaches()?s.getAttaches().toArray():N),s instanceof F.Edge&&(u.source=s.getSource(),u.target=s.getTarget())}else"remove"===r?u={kind:r,data:s,event:a}:"dataModelProperty"===r&&Y.isDataModelPropertyUndoable(k,s)&&(u={kind:r,property:k,oldValue:Y.cloneValue(a.oldValue,s,k),newValue:Y.cloneValue(a.newValue,s,k),event:a});Y.addHistory(u)}}},addHistory:function(z){var $=this;if(z)if($._betweenTransaction){var P=(z.data?z.data._id:0)+"_"+z.kind+"_"+z.property;if("property"===z.kind||"dataModelProperty"===z.kind){var p=$._transactionHistories[P];p&&(z.oldValue=p.oldValue)}$._transactionHistories[P]=z}else{var u=$._histories;u=u.slice(0,$._historyIndex+1),u.push([z]),u.length>$._maxHistoryCount&&(u=u.slice(u.length-$._maxHistoryCount)),$.setHistories(u),$.setHistoryIndex(u.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(v){(!v||0>=v)&&(v=1),this.setHistoryIndex(this._historyIndex-v)},$1p:function(j){if(this.canUndo()){var Y,V=this,l=V._dataModel,X=V._histories,q=V._historyIndex,P=0;for(V._isUndoRedoing=!0,i.setIsolating(!0);j>0;){if(q>=0&&q<X.length){P++,Y=X[q],q--;for(var h=Y.length-1;h>=0;h--){var v=Y[h],y=v.kind,L=v.data,e=v.property,N=v.event,t=this.cloneValue(v.oldValue,L,e);if(v.undo)v.undo();else if("add"===y)l.remove(L,{keepChildren:!0});else if("remove"===y)l.contains(L)||l.add(L,N.rootsIndex,N.datasIndex);else if("clear"===y)l.deserialize(i.clone(v.json));else if("property"===y)if("parent"===e)t?t.addChild(L,N.oldIndex):(L.setParent(t),N.oldIndex>=0&&l.moveTo(L,N.oldIndex));else{var D=null;0===e.indexOf("a:")?(D="attr",e=e.replace("a:","")):0===e.indexOf("s:")?(D="style",e=e.replace("s:","")):0===e.indexOf("f:")&&(D="field",e=e.replace("f:","")),Q.setPropertyValue(L,D,e,t)}else if("dataModelProperty"===y){var D=null;0===e.indexOf("a:")?(D="attr",e=e.replace("a:","")):0===e.indexOf("s:")?(D="style",e=e.replace("s:","")):0===e.indexOf("f:")&&(D="field",e=e.replace("f:","")),Q.setPropertyValue(l,D,e,t)}else"hierarchy"===y?l.moveTo(L,v.oldIndex):"index"===y?l.moveToIndex(L,v.oldIndex):"selection"===y&&l.sm().ss(v.oldValue)}}j--}i.setIsolating(!1),delete V._isUndoRedoing,V.afterUndo(P)}},afterUndo:function(){},redo:function(T){(!T||0>=T)&&(T=1),this.setHistoryIndex(this._historyIndex+T)},$2p:function(d){if(this.canRedo()){var I,N=this,G=N._dataModel,B=N._histories,s=N._historyIndex,W=0;for(N._isUndoRedoing=!0,i.setIsolating(!0);d>0;){if(s>=-1&&s<B.length-1){W++,s++,I=B[s];for(var b=0;b<I.length;b++){var l=I[b],J=l.kind,A=l.data,c=l.property,g=l.event,H=this.cloneValue(l.newValue,A,c);if(l.redo)l.redo();else if("add"===J)l.parent&&!A.getParent()&&l.parent.addChild(A,l.siblingsIndex),G.contains(A)||G.add(A,g.rootsIndex,g.datasIndex),this.restoreChildren(l.childrenInfo),A instanceof F.Node&&(A.setHost(l.host),l.attaches&&l.attaches.forEach(function(t){t.setHost(A)})),A instanceof F.Edge&&(A.setSource(l.source),A.setTarget(l.target));else if("remove"===J)G.remove(A);else if("clear"===J)G.clear();else if("property"===J)if("parent"===c)H?H.addChild(A,g.newIndex):(A.setParent(H),g.newIndex>=0&&G.moveTo(A,g.newIndex));else{var t=null;0===c.indexOf("a:")?(t="attr",c=c.replace("a:","")):0===c.indexOf("s:")?(t="style",c=c.replace("s:","")):0===c.indexOf("f:")&&(t="field",c=c.replace("f:","")),Q.setPropertyValue(A,t,c,H)}else if("dataModelProperty"===J){var t=null;0===c.indexOf("a:")?(t="attr",c=c.replace("a:","")):0===c.indexOf("s:")?(t="style",c=c.replace("s:","")):0===c.indexOf("f:")&&(t="field",c=c.replace("f:","")),Q.setPropertyValue(G,t,c,H)}else"hierarchy"===J?G.moveTo(A,l.newIndex):"index"===J?G.moveToIndex(A,l.newIndex):"selection"===J&&G.sm().ss(l.newValue)}}d--}i.setIsolating(!1),delete N._isUndoRedoing,this.afterRedo(W)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);